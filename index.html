<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>moron.js Index</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.dark.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cyborg.css">

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">moron.js</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="MoronManyToManyRelation.html">MoronManyToManyRelation</a>
						</li>
						
						<li>
							<a href="MoronModel.html">MoronModel</a>
						</li>
						
						<li>
							<a href="MoronModelBase.html">MoronModelBase</a>
						</li>
						
						<li>
							<a href="MoronOneToManyRelation.html">MoronOneToManyRelation</a>
						</li>
						
						<li>
							<a href="MoronOneToOneRelation.html">MoronOneToOneRelation</a>
						</li>
						
						<li>
							<a href="MoronQueryBuilder.html">MoronQueryBuilder</a>
						</li>
						
						<li>
							<a href="MoronRelation.html">MoronRelation</a>
						</li>
						
						<li>
							<a href="MoronRelationExpression.html">MoronRelationExpression</a>
						</li>
						
						<li>
							<a href="MoronValidationError.html">MoronValidationError</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="global.html#ensureArray">ensureArray</a>
						</li>
						
						<li>
							<a href="global.html#inherits">inherits</a>
						</li>
						
						<li>
							<a href="global.html#isSubclassOf">isSubclassOf</a>
						</li>
						
						<li>
							<a href="global.html#queryMethod">queryMethod</a>
						</li>
						
						<li>
							<a href="global.html#transaction">transaction</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
		<div class="span8">
			
				<div id="main">
					


	
	<span class="page-title">Index</span>
	
	












	
	





    <section class="readme-section">
        <article><h1>moron.js <a href="https://travis-ci.org/Vincit/moron.js"><img src="https://travis-ci.org/Vincit/moron.js.svg?branch=master" alt="Build Status"></a> <a href="https://coveralls.io/r/Vincit/moron.js"><img src="https://coveralls.io/repos/Vincit/moron.js/badge.svg" alt="Coverage Status"></a></h1><p>Moron.js is a Node.js ORM built around the wonderful SQL query builder <a href="http://knexjs.org">knex</a>. All databases
supported by knex are supported by moron.js. <strong>SQLite3</strong>, <strong>Postgres</strong> and <strong>MySQL</strong> are fully tested.</p>
<p>What moron.js gives you:</p>
<ul>
<li>An easy declarative way of <a href="#example-model">defining models</a> and relations between them</li>
<li>Simple and fun way to <a href="#query-examples">fetch, insert, update and delete</a> models using the full power of SQL</li>
<li>A way to <a href="#documents">store complex documents</a> as single rows</li>
<li>Powerful mechanism for loading arbitrarily large <a href="#fetching-relations-eagerly">trees of relations</a></li>
<li>Completely <a href="https://github.com/petkaantonov/bluebird">Promise</a> based API</li>
<li>Simple <a href="#transactions">transactions</a></li>
<li><a href="http://json-schema.org/">JSON schema</a> validation</li>
</ul>
<p>What moron.js doesn't give you:</p>
<ul>
<li>A custom query DSL. SQL is used everywhere</li>
<li>Automatic database schema creation and migration
 Automatic schema creation and migration is useful for the simple things, but usually just gets in your
 way when doing anything non-trivial. Moron.js leaves the schema and migration related things to you.
 knex has a great <a href="http://knexjs.org/#Migrations">migration tool</a> that we recommend for this job.</li>
</ul>
<h1>Installation</h1><pre class="prettyprint source lang-sh"><code>npm install moron</code></pre><h1>Getting started</h1><p>Best way to get started is to use one of the example projects:</p>
<pre class="prettyprint source lang-sh"><code>git clone git@github.com:Vincit/moron.js.git
cd moron/examples/express
sh install.sh
npm start</code></pre><p>The <code>express</code> example project is a simple express server. The <code>example-requests.sh</code> file contains a bunch of curl
commands for you to start playing with the REST API.</p>
<pre class="prettyprint source lang-sh"><code>cat example-requests.sh</code></pre><p>Also our <a href="http://vincit.github.io/moron.js">API documentation</a> contains a lot of examples.</p>
<h1>Query examples</h1><p>The Person model used in the examples is defined <a href="#example-model">here</a>.</p>
<p>All queries are started with one of the <a href="http://vincit.github.io/moron.js/MoronModel.html">MoronModel</a> methods <a href="http://vincit.github.io/moron.js/MoronModel.html#_P_query">query()</a>,
<a href="http://vincit.github.io/moron.js/MoronModel.html#Squery">$query()</a> or <a href="http://vincit.github.io/moron.js/MoronModel.html#SrelatedQuery">$relatedQuery()</a>.
All these methods return a <a href="http://vincit.github.io/moron.js/MoronQueryBuilder.html">MoronQueryBuilder</a> instance that can be used just like
a <a href="http://knexjs.org/#Builder">knex QueryBuilder</a>.</p>
<p>Insert a Person model to the database:</p>
<pre class="prettyprint source lang-js"><code>Person
  .query()
  .insert({firstName: 'Jennifer', lastName: 'Lawrence'})
  .then(function (jennifer) {
    console.log(jennifer instanceof Person); // --> true
    console.log(jennifer.id);
    console.log(jennifer.firstName); // --> Jennifer
  })
  .catch(function (err) {
    console.log('oh noes');
  });</code></pre><p>Fetch all Persons from the database:</p>
<pre class="prettyprint source lang-js"><code>Person
  .query()
  .then(function (persons) {
    console.log(persons[0] instanceof Person); // --> true
    console.log('there are', persons.length, 'Persons in total');
  })
  .catch(function (err) {
    console.log('oh noes');
  });</code></pre><p>The <code>.query()</code> method has all the methods a <a href="http://knexjs.org/#Builder">knex QueryBuilder</a> has. Here
is a simple example that uses some of them:</p>
<pre class="prettyprint source lang-js"><code>Person
  .query()
  .where('age', '>', 40)
  .andWhere('age', '&lt;', 60)
  .andWhere('firstName', 'Jennifer')
  .orderBy('lastName')
  .then(function (middleAgedJennifers) {
    console.log('The last name of the first middle aged Jennifer is');
    console.log(middleAgedJennifers[0].lastName);
  });</code></pre><p>Update models:</p>
<pre class="prettyprint source lang-js"><code>Person
  .query()
  .patch({lastName: 'Dinosaur'});
  .where('age', '>', 60)
  .then(function (patch) {
    console.log('all persons over 60 years old are now dinosaurs');
    console.log(patch.lastName); // --> Dinosaur.
  })
  .catch(function (err) {
    console.log(err.stack);
  });</code></pre><p>While the static <code>.query()</code> method can be used to create a query to a whole table <code>.$relatedQuery()</code> method
can be used to query a single relation. <code>.$relatedQuery()</code> returns an instance of <code>MoronQueryBuilder</code> just like
the <code>.query()</code> method.</p>
<pre class="prettyprint source lang-js"><code>var jennifer;
Person
  .query()
  .where('firstName', 'Jennifer')
  .first()
  .then(function (person) {
    jennifer = person;
    return jennifer
      .$relatedQuery('pets')
      .where('species', 'dog')
      .orderBy('name');
  })
  .then(function (jennifersDogs) {
    console.log(jennifersDogs[0] instanceof Animal); // --> true
    console.log(jennifer.pets === jennifersDogs); // --> true
    console.log('Jennifer has', jennifersDogs.length, 'dogs');
  })
  .catch(function (err) {
    console.log(err.stack);
  });</code></pre><p>Insert a related model:</p>
<pre class="prettyprint source lang-js"><code>Person
  .query()
  .where('id', 100)
  .first()
  .then(function (person) {
    return person.$relatedQuery('pets').insert({name: 'Fluffy'});
  })
  .then(function (fluffy) {
    console.log(fully.id);
  })
  .catch(function (err) {
    console.log('something went wrong with finding the person OR inserting the pet');
    console.log(err.stack);
  });</code></pre><h1>Fetching relations eagerly</h1><p>Okay I said there is no custom DSL but actually we have teeny-tiny one for fetching relations eagerly. The following
examples demonstrate how to use it:</p>
<p>Fetch one relation:</p>
<pre class="prettyprint source lang-js"><code>Person
  .query()
  .eager('pets')
  .then(function (persons) {
    // Each person has the `.pets` property populated with Animal objects related
    // through `pets` relation.
    console.log(persons[0].pets[0].name);
    console.log(persons[0].pets[0] instanceof Animal); // --> true
  });</code></pre><p>Fetch multiple relations on multiple levels:</p>
<pre class="prettyprint source lang-js"><code>Person
  .query()
  .eager('[pets, children.[pets, children]]')
  .then(function (persons) {
    // Each person has the `.pets` property populated with Animal objects related
    // through `pets` relation. The `.children` property contains the Person's
    // children. Each child also has the `pets` and `children` relations eagerly
    // fetched.
    console.log(persons[0].pets[0].name);
    console.log(persons[1].children[2].pets[1].name);
    console.log(persons[1].children[2].children[0].name);
  });</code></pre><p>Fetch one relation recursively:</p>
<pre class="prettyprint source lang-js"><code>Person
  .query()
  .eager('[pets, children.^]')
  .then(function (persons) {
    // The children relation is from Person to Person. If we want to fetch the whole
    // descendant tree of a person we can just say &quot;fetch this relation recursively&quot;
    // using the `.^` notation.
    console.log(persons[0].children[0].children[0].children[0].children[0].firstName);
  });</code></pre><p>The expressions can be arbitrarily deep. See the full description <a href="http://vincit.github.io/moron.js/MoronRelationExpression.html">here</a>.</p>
<p>Because the eager expressions are strings they can be easily passed for example as a query parameter of an HTTP
request. However using such expressions opens the whole database through the API. This is not very secure. Therefore
the <a href="http://vincit.github.io/moron.js/MoronQueryBuilder.html">MoronQueryBuilder</a> has the <code>.allowEager</code> method.
allowEager can be used to limit the allowed eager expression to a certain subset. Like this:</p>
<pre class="prettyprint source lang-js"><code>expressApp.get('/persons', function (req, res, next) {
  Person
    .query()
    .allowEager('[pets, children.pets]')
    .eager(req.query.eager)
    .then(function (persons) { res.send(persons); })
    .catch(next);
});</code></pre><p>The example above allows <code>req.query.eager</code> to be one of <code>'pets'</code>, <code>'children'</code>, <code>'children.pets'</code>, <code>'[pets, children]'</code> and
<code>'[pets, children.pets]'</code>. Examples of failing eager expressions are <code>'movies'</code>, <code>'children.children'</code> and <code>'notEvenAnExistingRelation'</code>.</p>
<p>In addition to the <code>.eager</code> method relations can be fetched using the <code>loadRelated</code> and <code>$loadRelated</code> methods of
<a href="http://vincit.github.io/moron.js/MoronModel.html">MoronModel</a>.</p>
<h1>Transactions</h1><p>Transactions are started by calling the <a href="http://vincit.github.io/moron.js/global.html#transaction">moron.transaction</a>
function. Give all the models you want to use in the transaction as parameters to the <code>transaction</code> function. The model
classes are bound to a newly created transaction and passed to the callback function. Inside this callback all queries
started through them take part in the same transaction.</p>
<p>The transaction is committed if the returned Promise is resolved successfully. If the returned Promise is rejected
the transaction is rolled back.</p>
<pre class="prettyprint source lang-js"><code>moron.transaction(Person, Animal, function (Person, Animal) {

  return Person
    .query()
    .insert({firstName: 'Jennifer', lastName: 'Lawrence'})
    .then(function () {
      return Animal
        .query()
        .insert({name: 'Scrappy'});
    });

}).then(function (scrappy) {
  console.log('Jennifer and Scrappy were successfully inserted');
}).catch(function (err) {
  console.log('Something went wrong. Neither Jennifer nor Scrappy were inserted');
});</code></pre><h1>Documents</h1><p>Moron.js makes it easy to store non-flat documents as table rows. All properties of a model that are marked as
objects or arrays in the model's <code>jsonSchema</code> are automatically converted to JSON strings in the database and
back to objects when read from the database. The database columns for the object properties can be a normal
text columns. Postgresql has the json and jsonb data types that can be used instead.</p>
<p>The <code>address</code> property of the Person model is defined as an object in the <a href="#example-model">Person.jsonSchema</a>:</p>
<pre class="prettyprint source lang-js"><code>Person
  .query()
  .insert({
    firstName: 'Jennifer',
    lastName: 'Lawrence',
    age: 24,
    address: {
      street: 'Somestreet 10',
      zipCode: '123456',
      city: 'Tampere'
    }
  })
  .then(function (jennifer) {
    console.log(jennifer.address.city); // --> Tampere
    return Person.query().where('id', jennifer.id);
  })
  .then(function (jenniferFromDb) {
    console.log(jenniferFromDb.address.city); // --> Tampere
  })
  .catch(function (err) {
    console.log('oh noes');
  });</code></pre><h1>Example model</h1><p>Models are created by inheriting from the <a href="http://vincit.github.io/moron.js/MoronModel.html">MoronModel</a> base class.
In moron.js the inheritance is done as transparently as possible. There is no custom Class abstraction making you
wonder what the hell is happening. Just plain old ugly javascript inheritance.</p>
<pre class="prettyprint source lang-js"><code>var MoronModel = require('moron').MoronModel;

/**
 * @override MoronModel
 * @constructor
 */
function Person() {
  MoronModel.apply(this, arguments);
}

MoronModel.extend(Person);
module.exports = Person;

// Table name is the only required property.
Person.tableName = 'Person';

// This is not the database schema! Nothing is generated based on this. Whenever a
// Person object is created from a JSON object, the JSON is checked against this
// schema. For example when you call Person.fromJson({firstName: 'Jennifer'});
Person.jsonSchema = {
  type: 'object',
  required: ['firstName', 'lastName'],

  properties: {
    id: {type: 'integer'},
    parentId: {type: ['integer', 'null']},
    firstName: {type: 'string', minLength: 1, maxLength: 255},
    lastName: {type: 'string', minLength: 1, maxLength: 255},
    age: {type: 'number'},

    address: {
      type: 'object',
      properties: {
        street: {type: 'string'},
        city: {type: 'string'},
        zipCode: {type: 'string'}
      }
    }
  }
};

// This object defines the relations to other models.
Person.relationMappings = {
  pets: {
    relation: MoronModel.OneToManyRelation,
    // The related model. This can be either a MoronModel subclass constructor or an
    // absolute file path to a module that exports one. We use the file path version
    // here to prevent require loops.
    modelClass: __dirname + '/Animal',
    join: {
      from: 'Person.id',
      to: 'Animal.ownerId'
    }
  },

  movies: {
    relation: MoronModel.ManyToManyRelation,
    modelClass: __dirname + '/Movie',
    join: {
      from: 'Person.id',
      // ManyToMany relation needs the `through` object to describe the join table.
      through: {
        from: 'Person_Movie.personId',
        to: 'Person_Movie.movieId'
      },
      to: 'Movie.id'
    }
  },

  children: {
    relation: MoronModel.OneToManyRelation,
    modelClass: Person,
    join: {
      from: 'Person.id',
      to: 'Person.parentId'
    }
  }
};</code></pre></article>
    </section>







				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		moron.js Copyright © 2015-2015 Sami Koskimäki.
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.1</a>
		on Sun Jun 14th 2015 using the <a
			href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<div class="span3">
				<div id="toc"></div>
			</div>
			
			<br clear="both">
		</div>

	</div>
	<!-- <script src="scripts/sunlight.js"></script> -->
	<script src="scripts/docstrap.lib.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>

	<script>
		$( function () {
			$( "[id*='$']" ).each( function () {
				var $this = $( this );
				$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
			} );

			$( '.dropdown-toggle' ).dropdown();
			$( "pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

			$( "pre" ).each( function () {
				var $this = $( this );

				var example = $this.find( "code" );
				exampleText = example.html();
				var lang = /{@lang (.*?)}/.exec( exampleText );
				if ( lang && lang[1] ) {
					exampleText = exampleText.replace( lang[0], "" );
					example.html( exampleText );
					lang = lang[1];
				} else {
					lang = "javascript";
				}

				if ( lang ) {

					$this
						.addClass( "sunlight-highlight-" + lang )
						.addClass( "linenums" )
						.html( example.html() );

				}
			} );

			Sunlight.highlightAll( {
				lineNumbers : true,
				showMenu : true,
				enableDoclinks : true
			} );

      $( "#toc" ).toc( {
        anchorName  : function ( i, heading, prefix ) {
          return $( heading ).attr( "id" ) || ( prefix + i );
        },
        selectors   : "h1,h2,h3,h4",
        showAndHide : false,
        scrollTo    : "100px"
      } );

      $( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
      $( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	 </script>



	<!--Navigation and Symbol Display-->
	


	<!--Google Analytics-->
	

</body>
</html>